<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siriwardana Mobile - LPR Loan Records Tracker (User Login)</title>
    <link rel="icon" type="image/png" href="https://placehold.co/64x64/0000FF/FFFFFF?text=SM">
    <link rel="apple-touch-icon" href="https://placehold.co/64x64/0000FF/FFFFFF?text=SM">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Sinhala Noto Font for Placeholders */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        /* NEW: Dancing Script for Signature look */
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        /* Ensure the Inter font is used for general text */
        body {
            font-family: 'Inter', 'sans-serif';
            background-color: #f7f9fc;
            transition: background-color 0.3s, color 0.3s; /* Transition for dark mode */
        }
        /* Apply Sinhala font to placeholders */
        input::placeholder, textarea::placeholder {
            font-family: 'Noto Sans Sinhala', sans-serif !important;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f7f9fc;
        }
        .paid-row {
            background-color: #d1fae5 !important; /* Light Green for Paid */
            transition: background-color 0.3s ease;
        }
        /* Animation for Logo (Pulse) */
        @keyframes pulse-logo {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 15px rgba(0, 0, 255, 0.4);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
                box-shadow: 0 0 25px rgba(0, 0, 255, 0.8);
            }
        }
        .animate-pulse-logo {
            animation: pulse-logo 1.5s infinite ease-in-out;
        }
        /* Animation for Siriwardana Mobile Header (RGB Color Cycle) */
        @keyframes color-cycle {
            0% {
                color: #ef4444;
            }
            25% {
                color: #3b82f6;
            }
            50% {
                color: #10b981;
            }
            75% {
                color: #a855f7;
            }
            100% {
                color: #ef4444;
            }
        }
        .animate-color-cycle {
            animation: color-cycle 5s infinite linear;
            transition: color 0.5s ease-in-out;
        }
        /* Custom checkbox size for better mobile tap target */
        .large-checkbox {
            transform: scale(1.5);
            cursor: pointer;
            min-height: 24px;
            min-width: 24px;
        }
        /* --- DARK MODE SWITCH STYLING --- */
        .mode-switch {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .mode-label {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981; /* Tailwind Green 500 */
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: #121212 !important;
            color: #E0E0E0 !important;
        }
        /* General background adjustments for dark mode */
        body.dark-mode header, body.dark-mode footer, body.dark-mode .bg-white {
            background-color: #1E1E1E !important;
            border-color: #333 !important;
        }
        /* Specific section background/border adjustments for dark mode */
        body.dark-mode #status, body.dark-mode .bg-indigo-50, body.dark-mode .bg-gray-100, body.dark-mode .bg-yellow-100 {
            background-color: #2D2D2D !important;
            border-color: #444 !important;
        }
        /* Text colors in Dark Mode */
        body.dark-mode h1, body.dark-mode h2, body.dark-mode p, body.dark-mode label {
            color: #E0E0E0 !important;
        }
        body.dark-mode .text-gray-800, body.dark-mode .text-gray-700, body.dark-mode .text-gray-500 {
            color: #B0B0B0 !important;
        }
        /* Input field adjustments */
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #333 !important;
            border-color: #444 !important;
            color: #E0E0E0 !important;
        }
        /* Table adjustments */
        body.dark-mode .divide-gray-200 {
            border-color: #333 !important;
        }
        body.dark-mode .bg-indigo-50, body.dark-mode .bg-indigo-100, body.dark-mode .bg-gray-50 {
            background-color: #2D2D2D !important;
        }
        body.dark-mode .paid-row {
            background-color: #166534 !important; /* Darker Green for Paid */
        }
        /* Dark Mode Switch adjustments */
        body.dark-mode .mode-switch {
            background-color: rgba(30, 30, 30, 0.9);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .mode-label {
            color: #E0E0E0;
        }
        /* Print Specific Styles for Thermal Printer */
        @media print {
            body > * {
                display: none !important;
            }
            #printContainer {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 300px !important;
                max-width: 300px !important;
                margin: 0 auto !important;
                padding: 0 !important;
                box-shadow: none !important;
                overflow: hidden !important;
                z-index: 99999 !important;
            }
            body {
                color: #000 !important;
                background-color: #fff !important;
                font-family: monospace !important;
                font-size: 10pt !important;
            }
            #printContainer .print-area {
                padding: 10px 5px !important;
                color: #000 !important;
                font-family: monospace !important;
            }
            #receiptModal {
                display: none !important;
            }
            .border-dashed {
                border-style: dashed !important;
                border-width: 1px !important;
            }
            ::-webkit-scrollbar {
                width: 0 !important;
                height: 0 !important;
            }
            .animate-color-cycle {
                animation: none !important;
                color: #000 !important;
            }
        }
        #receiptModal > div {
            max-width: 400px;
        }
        /* NEW FONT STYLE */
        .font-dancing-script {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem !important;
            font-weight: 700;
        }
        /* NEW: Utility class to hide buttons */
        .hidden-settle {
            display: none !important;
        }

        /* NEW: Online Status Styling */
        .online-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #10B981; /* Green 500 */
            background-color: #D1FAE5; /* Green 100 */
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background-color: #10B981; /* Green 500 */
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse-online 1.5s infinite;
        }
        .offline-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #F87171; /* Red 400 */
            background-color: #FEE2E2; /* Red 100 */
        }
        .offline-dot {
            width: 8px;
            height: 8px;
            background-color: #EF4444; /* Red 500 */
            border-radius: 50%;
            margin-right: 4px;
        }
        @keyframes pulse-online {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        /* Dark Mode adjustments for presence */
        body.dark-mode .online-badge {
            color: #10b981;
            background-color: #14532D; /* Darker green background */
        }
        body.dark-mode .offline-badge {
            color: #FCA5A5; /* Lighter red text */
            background-color: #7F1D1D; /* Darker red background */
        }
    </style>
</head>
<body>
    <div class="container mx-auto">
        <div class="mode-switch">
            <label class="switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
            <span class="mode-label" id="modeLabel">Light Mode</span>
        </div>
        <header class="py-6 border-b border-gray-200">
            <div class="flex flex-col items-center justify-center space-y-2">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRn0Hz-y61XQ-3RgTeYFbMDN4ZaVuJozrSYJA&s" alt="App Logo" class="h-16 w-16 object-cover rounded-xl shadow-md animate-pulse-logo" onerror="this.onerror=null; this.src='https://placehold.co/64x64/0000FF/FFFFFF?text=SM';">
                <h1 class="text-3xl font-bold text-gray-800 animate-color-cycle">Siriwardana Mobile</h1>
                <p class="text-2xl font-bold text-indigo-600 font-dancing-script">LPR</p>
            </div>
        </header>
        <div id="status" class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm text-sm text-indigo-800">
            <p class="font-semibold">System Status: <span id="userIdDisplay" class="font-mono text-xs bg-indigo-100 px-2 py-1 rounded"> Connecting to Cloud Database... </span> </p>
            <p id="cloudInfo" class="mt-1 text-xs text-indigo-700 font-medium"> Data is saved in the Cloud Database (Firestore) in real-time and shared among all users. </p>
        </div>

        <section id="cashierOnlineStatus" class="mt-4 p-4 bg-gray-100 border border-gray-300 rounded-lg shadow-inner hidden">
            <h3 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">üë§ Cashiers Online Status (Real-time)</h3>
            <div id="onlineStatusBadges" class="flex flex-wrap gap-3">
                </div>
        </section>


        <section id="loginSection" class="mt-6 p-6 bg-yellow-100 border border-yellow-400 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-yellow-800 mb-4 text-center">User Login</h2>
            <div id="loginMessage" class="hidden p-3 mb-4 text-sm font-medium rounded-lg"></div>
            <div class="flex flex-col space-y-4">
                <div>
                    <label for="loginUserName" class="block text-sm font-medium text-gray-700 mb-1">Select Name</label>
                    <select id="loginUserName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg">
                        <option value="" disabled selected>Name</option>
                        <option value="Ashan">Ashan</option>
                        <option value="Dilshan">Dilshan</option>
                        <option value="Gihan">Gihan</option>
                        <option value="Menushi">Menushi</option>
                    </select>
                </div>
                <div>
                    <label for="passcodeInput" class="block text-sm font-medium text-gray-700 mb-1">Passcode</label>
                    <input type="password" id="passcodeInput" placeholder="‡∂ª‡∑Ñ‡∑É‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫" required maxlength="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg">
                </div>
                <button type="button" id="loginButton" class="bg-yellow-600 text-white p-3 rounded-lg font-bold text-xl transition duration-150 shadow-lg hover:bg-yellow-700"> Login </button>
            </div>
        </section>
        <div id="mainAppContent" class="hidden">
            <section class="mt-6 p-5 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Loan Record - PENDING Status</h2>
                <form id="loanForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="loanNumber" placeholder="‡∂´‡∂∫ ‡∂Ö‡∂Ç‡∂ö‡∂∫ - 13 ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏‡∑ä ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í" required maxlength="13" pattern="[0-9]{13}" title="Loan Number must be exactly 13 digits." class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="text" id="phoneNumber" placeholder="‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫" required class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="relative">
                        <input type="number" id="amount" placeholder="‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂´‡∂∫ ‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ú‡∂´‡∂±‡∂∫‡∂ß ‡∂¥‡∂∏‡∂´‡∑í)" required min="1" class="w-full p-3 pr-32 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <span id="amountPreview" class="absolute inset-y-0 right-0 flex items-center pr-1 text-xs font-bold text-blue-700 bg-blue-100 rounded-r-lg px-2 shadow-inner whitespace-nowrap"> +1.5%: Rs. 0.00 </span>
                    </div>
                    <input type="number" id="paidValue" placeholder="‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î‡∂ö‡∂ª‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω" required min="0" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="md:col-span-2 p-3 bg-gray-100 border border-gray-300 rounded-lg shadow-inner">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Payment Method (*Select before marking as Paid*):</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="paymentMethodRadio" value="Cash" class="form-radio text-green-600 h-5 w-5" checked>
                                <span class="text-sm font-medium text-green-700">Cash</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="paymentMethodRadio" value="Card" class="form-radio text-blue-600 h-5 w-5">
                                <span class="text-sm font-medium text-blue-700">Card</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="paymentMethodRadio" value="Online" class="form-radio text-purple-600 h-5 w-5">
                                <span class="text-sm font-medium text-purple-700">Online</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="paymentMethodRadio" value="" class="form-radio text-gray-500 h-5 w-5">
                                <span class="text-sm font-medium text-gray-700">None/Pending</span>
                            </label>
                        </div>
                    </div>
                    <div id="calculatedPreview" class="md:col-span-2 p-3 bg-indigo-100 border border-indigo-300 rounded-lg text-sm text-indigo-800 font-medium"> -1.5% Calculated Value (Deduction): <span id="previewValue" class="font-bold">Rs. 0.00</span> </div>
                    <button type="submit" id="submitButton" disabled class="md:col-span-2 bg-gray-400 text-white p-3 rounded-lg font-semibold transition duration-150 shadow-md"> Add Record and Print Receipt </button>
                </form>
                <div id="messageBox" class="mt-4 p-3 hidden bg-red-100 text-red-700 rounded-lg"></div>
            </section>
            <section class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Loan Records</h2>
                <div id="whatsappMessageBox" class="mt-4 p-3 bg-green-50 border border-green-300 rounded-lg shadow-md hidden flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-4">
                    <p id="whatsappMessageTitle" class="text-base font-bold text-green-800 text-center sm:text-left flex-grow"> </p>
                    <a id="whatsappSendButton" target="_blank" href="#" class="flex items-center justify-center space-x-2 bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition duration-150 shadow-lg w-full sm:w-auto flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.002 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm4.018 17.509c-.27-.13-.71-.34-1.25-.66-.54-.32-3.13-1.54-3.62-1.74-.49-.2-.85-.3-.98.3s.38 1.48.54 1.78.33.34.66.44.69.2 1.35-.04 2.87-1.07 3.48-2.09c.61-1.01.4-1.87.28-2.08-.12-.21-.49-.32-.69-.42-.19-.1-.41-.15-.65-.15-.24 0-.5.06-.75.31-.25.25-.97.96-.97 2.34s1 2.71 1.13 2.84c.12.13.24.23.44.23s.47-.04.72-.25c.26-.2.43-.51.64-.78.19-.24.33-.42.47-.59.13-.17.29-.36.56-.63.26-.27.87-.29 1.22-.16.35.13.6.61.68 1.34s-.13 1.35-.27 1.62c-.14.28-.71.55-1.34.82z"/>
                        </svg>
                        <span class="text-sm">Send Receipt via WhatsApp</span>
                    </a>
                </div>
                <div class="flex flex-col space-y-4 mb-4">
                    <input type="text" id="searchLoanNumber" placeholder="‡∂´‡∂∫ ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±" class="p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 p-3 bg-gray-100 rounded-lg shadow-inner">
                        <label for="filterDate" class="text-sm font-semibold text-gray-700 whitespace-nowrap">Filter by Date:</label>
                        <input type="date" id="filterDate" class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 flex-grow">
                        <button id="clearFilterButton" title="Clear Filter" class="p-2 px-4 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-150 flex-shrink-0"> Clear Filter </button>
                    </div>
                </div>
                
                <h3 class="text-lg font-bold text-indigo-700 mb-3 border-b pb-1">üìä User Performance Summary (Paid Records Only)</h3>
                <div id="userPerformanceSummary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="p-4 bg-purple-50 border border-purple-300 rounded-lg shadow-md">
                        <p class="font-bold text-purple-800 text-sm md:text-base">Ashan</p>
                        <p class="text-xs text-gray-600">Records: <span id="ashanCount" class="font-extrabold text-purple-700">0</span></p>
                        <p class="text-sm font-extrabold text-indigo-800 mt-1" id="ashanNetTotal">Rs. 0.00</p>
                    </div>
                    <div class="p-4 bg-pink-50 border border-pink-300 rounded-lg shadow-md">
                        <p class="font-bold text-pink-800 text-sm md:text-base">Dilshan</p>
                        <p class="text-xs text-gray-600">Records: <span id="dilshanCount" class="font-extrabold text-pink-700">0</span></p>
                        <p class="text-sm font-extrabold text-indigo-800 mt-1" id="dilshanNetTotal">Rs. 0.00</p>
                    </div>
                    <div class="p-4 bg-teal-50 border border-teal-300 rounded-lg shadow-md">
                        <p class="font-bold text-teal-800 text-sm md:text-base">Gihan</p>
                        <p class="text-xs text-gray-600">Records: <span id="gihanCount" class="font-extrabold text-teal-700">0</span></p>
                        <p class="text-sm font-extrabold text-indigo-800 mt-1" id="gihanNetTotal">Rs. 0.00</p>
                    </div>
                    <div class="p-4 bg-orange-50 border border-orange-300 rounded-lg shadow-md">
                        <p class="font-bold text-orange-800 text-sm md:text-base">Menushi</p>
                        <p class="text-xs text-gray-600">Records: <span id="menushiCount" class="font-extrabold text-orange-700">0</span></p>
                        <p class="text-sm font-extrabold text-indigo-800 mt-1" id="menushiNetTotal">Rs. 0.00</p>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-red-700 mb-3 border-b pb-1 mt-6">üí≤Cashier Settlement</h3>
                <div id="settlementButtonsContainer" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <button data-user="Ashan" class="settle-button p-3 bg-red-100 border border-red-300 rounded-lg font-bold text-red-700 hover:bg-red-200 transition duration-150 shadow-md hidden-settle">
                        Ashan: Settle Now
                    </button>
                    <button data-user="Dilshan" class="settle-button p-3 bg-red-100 border border-red-300 rounded-lg font-bold text-red-700 hover:bg-red-200 transition duration-150 shadow-md hidden-settle">
                        Dilshan: Settle Now
                    </button>
                    <button data-user="Gihan" class="settle-button p-3 bg-red-100 border border-red-300 rounded-lg font-bold text-red-700 hover:bg-red-200 transition duration-150 shadow-md hidden-settle">
                        Gihan: Settle Now
                    </button>
                    <button data-user="Menushi" class="settle-button p-3 bg-red-100 border border-red-300 rounded-lg font-bold text-red-700 hover:bg-red-200 transition duration-150 shadow-md hidden-settle">
                        Menushi: Settle Now
                    </button>
                </div>

                <div class="flex flex-col space-y-3 mb-4">
                    <div class="grid grid-cols-3 gap-2">
                        <div id="cashCountDisplay" class="p-3 bg-green-50 border border-green-300 rounded-lg text-green-800 shadow-md text-center">
                            <span class="font-bold text-xs sm:text-sm block">Cash Payments (Count)</span>
                            <span id="cashCountSpan" class="text-green-700 text-lg sm:text-2xl font-extrabold">0</span>
                            <span class="font-bold text-xs sm:text-sm block mt-1">Total Net Value</span>
                            <span id="cashValueSpan" class="text-indigo-800 text-lg sm:text-xl font-extrabold">Rs. 0.00</span>
                        </div>
                        <div id="cardCountDisplay" class="p-3 bg-blue-50 border border-blue-300 rounded-lg text-blue-800 shadow-md text-center">
                            <span class="font-bold text-xs sm:text-sm block">Card Payments (Count)</span>
                            <span id="cardCountSpan" class="text-blue-700 text-lg sm:text-2xl font-extrabold">0</span>
                            <span class="font-bold text-xs sm:text-sm block mt-1">Total Net Value</span>
                            <span id="cardValueSpan" class="text-indigo-800 text-lg sm:text-xl font-extrabold">Rs. 0.00</span>
                        </div>
                        <div id="onlineCountDisplay" class="p-3 bg-purple-50 border border-purple-300 rounded-lg text-purple-800 shadow-md text-center">
                            <span class="font-bold text-xs sm:text-sm block">Online Payments (Count)</span>
                            <span id="onlineCountSpan" class="text-purple-700 text-lg sm:text-2xl font-extrabold">0</span>
                            <span class="font-bold text-xs sm:text-sm block mt-1">Total Net Value</span>
                            <span id="onlineValueSpan" class="text-indigo-800 text-lg sm:text-xl font-extrabold">Rs. 0.00</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div id="totalCalculatedDisplay" class="p-3 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 shadow-md flex flex-col space-y-1">
                            <span class="font-bold text-xs sm:text-sm block">Total Net Value:</span>
                            <span id="totalNetValueSpan" class="text-indigo-800 text-xl sm:text-2xl font-extrabold">Rs. 0.00</span>
                        </div>
                        <div id="totalMarkedCountDisplay" class="p-3 bg-teal-100 border border-teal-300 rounded-lg text-teal-800 shadow-md flex flex-col space-y-1">
                            <span class="font-bold text-xs sm:text-sm block">Total Paid Records:</span>
                            <span id="totalMarkedCountSpan" class="text-teal-700 text-xl sm:text-2xl font-extrabold">0</span>
                        </div>
                    </div>
                    <button id="downloadExcelButton" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md w-full"> Download as Excel File </button>
                </div>
                <div class="table-container overflow-x-auto rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200 bg-white">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th colspan="2" class="px-4 py-3 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider border-b border-indigo-200">Date & Time</th>
                                <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loan Number</th>
                                <th rowspan="2" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
                                <th colspan="2" class="px-4 py-3 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider border-b border-indigo-200">Amount</th>
                                <th rowspan="2" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Delete / Reprint</th>
                                <th rowspan="2" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider border-l border-indigo-200">Payment Method</th>
                                <th rowspan="2" class="px-4 py-3 text-center text-xs font-bold text-red-600 uppercase tracking-wider">Paid Status</th>
                                <th rowspan="2" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Added By (Name)</th>
                            </tr>
                            <tr>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider bg-indigo-100">Date</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider bg-indigo-100">Time</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider bg-indigo-100">Paid Value</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider bg-indigo-100">-1.5% (Net)</th>
                            </tr>
                        </thead>
                        <tbody id="loanTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="10" class="text-center py-4 text-gray-500">Connecting to Cloud Database...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
        <footer class="mt-10 mb-4 p-4 text-center border-t border-gray-200">
            <p class="text-xs text-gray-500 font-medium"> Developed by <span class="font-semibold text-indigo-600">Mithila</span> & Consultation by <span class="font-semibold text-indigo-600">Gayan</span> </p>
            <p class="text-xs text-indigo-500 font-medium mt-1"> *Note: This version uses **Cloud Firestore** for real-time collaboration, including user names. </p>
        </footer>
        <div id="confirmationModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 p-4" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
                <div class="p-6">
                    <h3 class="text-lg font-bold text-red-700" id="modalTitle">Confirm Deletion</h3>
                    <p class="mt-2 text-sm text-gray-700" id="modalMessage">Are you sure you want to permanently delete the record for Loan Number <span id="modalLoanNumber" class="font-mono font-semibold text-red-600"></span>? This action cannot be undone and will affect all users.</p>
                </div>
                <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                    <button id="cancelButton" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150"> Cancel </button>
                    <button id="confirmDeleteButton" type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md"> Delete Record </button>
                </div>
            </div>
        </div>
        
        <div id="settleConfirmationModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 p-4" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
                <div class="p-6">
                    <h3 class="text-lg font-bold text-red-700" id="settleModalTitle">Confirm Settlement</h3>
                    <p class="mt-2 text-sm text-gray-700" id="settleModalMessage">Are you sure you want to **Settle** the account for <span id="settleModalUserName" class="font-mono font-semibold text-red-600"></span>? This will reset the daily calculation and **mark ALL Paid records up to the Current Time as settled**.</p>
                </div>
                <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                    <button id="cancelSettleButton" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150"> Cancel </button>
                    <button id="confirmSettleButton" type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md"> Confirm Settle </button>
                </div>
            </div>
        </div>

        <div id="unpaidConfirmationModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 p-4" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all">
                <div class="p-6">
                    <h3 class="text-lg font-bold text-yellow-700">‚ö†Ô∏è Pending Payment Warning!</h3>
                    <p class="mt-2 text-sm text-gray-700" id="unpaidModalMessage">
                        You have <span id="unpaidCountSpan" class="font-extrabold text-red-600"></span> Unpaid (Pending Status) records in your current settlement batch.
                        <br><br>
                        If you click **OK**, the Paid records will be settled. The **Unpaid records will remain in your summary** for the next settlement.
                    </p>
                </div>
                <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                    <button id="cancelUnpaidSettleButton" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150"> Cancel </button>
                    <button id="okUnpaidSettleButton" type="button" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 shadow-md"> OK </button>
                </div>
            </div>
        </div>


        <div id="receiptModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4 print:hidden" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-full max-h-[90vh] overflow-y-auto transform transition-all p-0">
                <div id="receiptContent" class="p-6">
                </div>
                <div class="sticky bottom-0 bg-gray-100 px-6 py-4 flex justify-end space-x-3 border-t border-gray-200">
                    <button id="closeReceiptButton" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-200 transition duration-150 shadow-sm"> Close </button>
                    <button id="printButton" type="button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"> Print Receipt </button>
                </div>
            </div>
        </div>
    </div>
    <div id="printContainer" class="hidden"></div>
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase & App Variables ---
        let db;
        let auth;
        let currentUserId = null;
        let currentUserName = "N/A (Not Logged In)";
        let isAuthReady = false;
        let unsubscribeSnapshot = null;
        let unsubscribePresence = null; 
        let currentLoans = [];
        let userSettlementDate = {}; 
        let userToSettle = null; 
        const knownUsers = ["Ashan", "Dilshan", "Gihan", "Menushi"]; 
        const onlineUsers = {}; 

        // --- VITAL: Hardcoded User Passcodes (MUST BE ADDED) ---
        const USER_PASSCODES = {
            "Ashan": "1111", 
            "Dilshan": "2222", 
            "Gihan": "3333", 
            "Menushi": "4444" 
        };
        // --------------------------------------------------------

        // VITAL CHANGE: HARDCODED Firebase Configuration for rplp-44da4 Project
        // **IMPORTANT: Replace API Key and Project ID with your actual values if the connection fails**
        const appId = "rplp-44da4";
        const firebaseConfig = {
            apiKey: "AIzaSyBcn75ltTrkCsR4KJFHNvYiCeMtHB5Xv3s",
            authDomain: "rplp-44da4.firebaseapp.com",
            projectId: "rplp-44da4",
            storageBucket: "rplp-44da4.firebasestorage.app",
            messagingSenderId: "76131736218",
            appId: "1:76131736218:web:141f2800787d8e67929d23",
            // measurementId: "G-RWLXMVR86K" // Not needed for core functionality
        };

        const initialAuthToken = null; // No custom token used

        // Firestore Collection Paths
        const LOAN_RECORDS_PATH = `loan_records`;
        const USER_PRESENCE_PATH = `user_presence`; 
        const getUserProfilePath = (userId) => `users/${userId}`;

        // --- DOM Elements ---
        const mainAppContent = document.getElementById('mainAppContent');
        const loginSection = document.getElementById('loginSection');
        const loginUserNameSelect = document.getElementById('loginUserName');
        const passcodeInput = document.getElementById('passcodeInput');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const loanForm = document.getElementById('loanForm');
        const loanTableBody = document.getElementById('loanTableBody');
        const messageBox = document.getElementById('messageBox');
        const submitButton = document.getElementById('submitButton');
        const paidValueInput = document.getElementById('paidValue');
        const previewValueSpan = document.getElementById('previewValue');
        const downloadExcelButton = document.getElementById('downloadExcelButton');
        const amountInput = document.getElementById('amount');
        const amountPreviewSpan = document.getElementById('amountPreview');
        const filterDateInput = document.getElementById('filterDate');
        const clearFilterButton = document.getElementById('clearFilterButton');
        const searchLoanNumberInput = document.getElementById('searchLoanNumber');
        const totalNetValueSpan = document.getElementById('totalNetValueSpan');
        const totalMarkedCountSpan = document.getElementById('totalMarkedCountSpan');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalLoanNumberSpan = document.getElementById('modalLoanNumber');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelButton = document.getElementById('cancelButton');
        const receiptModal = document.getElementById('receiptModal');
        const receiptContent = document.getElementById('receiptContent');
        const printButton = document.getElementById('printButton');
        const closeReceiptButton = document.getElementById('closeReceiptButton');
        const whatsappMessageBox = document.getElementById('whatsappMessageBox');
        const whatsappMessageTitle = document.getElementById('whatsappMessageTitle');
        const whatsappSendButton = document.getElementById('whatsappSendButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const cashCountSpan = document.getElementById('cashCountSpan');
        const cardCountSpan = document.getElementById('cardCountSpan');
        const onlineCountSpan = document.getElementById('onlineCountSpan');
        
        // --- NEW DOM Elements for Payment Values ---
        const cashValueSpan = document.getElementById('cashValueSpan'); 
        const cardValueSpan = document.getElementById('cardValueSpan'); 
        const onlineValueSpan = document.getElementById('onlineValueSpan'); 
        
        // --- USER SUMMARY DOM ELEMENTS ---
        const ashanCountSpan = document.getElementById('ashanCount');
        const ashanNetTotalSpan = document.getElementById('ashanNetTotal');
        const dilshanCountSpan = document.getElementById('dilshanCount');
        const dilshanNetTotalSpan = document.getElementById('dilshanNetTotal');
        const gihanCountSpan = document.getElementById('gihanCount');
        const gihanNetTotalSpan = document.getElementById('gihanNetTotal');
        const menushiCountSpan = document.getElementById('menushiCount');
        const menushiNetTotalSpan = document.getElementById('menushiNetTotal');

        // --- SETTLEMENT DOM ELEMENTS ---
        const settlementButtonsContainer = document.getElementById('settlementButtonsContainer'); 
        const settleConfirmationModal = document.getElementById('settleConfirmationModal');
        const settleModalUserNameSpan = document.getElementById('settleModalUserName');
        const confirmSettleButton = document.getElementById('confirmSettleButton');
        const cancelSettleButton = document.getElementById('cancelSettleButton');
        
        // --- UNPAID CONFIRMATION DOM ELEMENTS ---
        const unpaidConfirmationModal = document.getElementById('unpaidConfirmationModal');
        const unpaidCountSpan = document.getElementById('unpaidCountSpan');
        const okUnpaidSettleButton = document.getElementById('okUnpaidSettleButton');
        const cancelUnpaidSettleButton = document.getElementById('cancelUnpaidSettleButton');

        // --- DARK MODE DOM ELEMENTS ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        const modeLabel = document.getElementById('modeLabel');
        
        // --- NEW PRESENCE DOM ELEMENTS ---
        const cashierOnlineStatus = document.getElementById('cashierOnlineStatus');
        const onlineStatusBadges = document.getElementById('onlineStatusBadges');


        let whatsappTimeout = null;
        let loanToDeleteId = null;
        let loanToDeleteNumber = null;

        // --- Utility Functions ---

        function showLoginMessage(message, isError = false) {
            loginMessage.textContent = message;
            loginMessage.className = `p-3 mb-4 text-sm font-medium rounded-lg ${isError ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`;
            loginMessage.style.display = 'block';
            setTimeout(() => {
                loginMessage.style.display = 'none';
            }, 5000);
        }

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 8000);
        }

        function formatCurrency(amount) {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) return 'Rs. 0.00';
            const formatted = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'LKR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numAmount);
            return formatted.replace('LKR', 'Rs.').trim().replace(/\s/g, '');
        }

        function formatDateTime(isoString) {
            if (!isoString) return {
                date: 'N/A',
                time: 'N/A'
            };
            const dateObj = new Date(isoString instanceof Date ? isoString : (isoString.toDate ? isoString.toDate() : isoString)); // Use Sri Lanka Time (Asia/Colombo) for all date/time formatting
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'Asia/Colombo'
            }; // Format date in YYYY-MM-DD format
            const date = dateObj.toLocaleDateString('en-US', options).split('/').reverse().join('-'); // Format time (24-hour)
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Colombo'
            };
            const time = dateObj.toLocaleTimeString('en-US', timeOptions);
            return {
                date,
                time
            };
        } 
        
        function getDateStringFromISO(isoString) {
            let dateObj;
            if (isoString && isoString.toDate) {
                dateObj = isoString.toDate();
            } else if (isoString) {
                dateObj = new Date(isoString);
            } else {
                return 'N/A';
            } // Use 'Asia/Colombo' Timezone for consistent date filtering
            const date = dateObj.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'Asia/Colombo' // SLST Timezone
            }).split('/').reverse().join('-');
            return date;
        }

        function getCurrentDateStringSLST() {
            const today = new Date(); 
            const offset = 330 * 60000; 
            const todaySLST = today.getTime() + today.getTimezoneOffset() * 60000 + offset; 
            const currentDate = new Date(todaySLST);
            const date = currentDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                timeZone: 'Asia/Colombo' 
            }).split('/').reverse().join('-');
            return date;
        }

        function updateAmountPreview() {
            const principalAmount = parseFloat(amountInput.value);
            if (isNaN(principalAmount) || principalAmount <= 0) {
                amountPreviewSpan.textContent = '+1.5%: Rs. 0.00';
                return;
            }
            const totalWithInterest = principalAmount * 1.015;
            amountPreviewSpan.textContent = `+1.5%: ${formatCurrency(totalWithInterest)}`;
        }

        function updateCalculatedPreview() {
            const paidValue = parseFloat(paidValueInput.value);
            if (isNaN(paidValue) || paidValue < 0) {
                previewValueSpan.textContent = 'Rs. 0.00';
                return;
            }
            const calculatedValue = paidValue * 0.985;
            previewValueSpan.textContent = formatCurrency(calculatedValue);
        }

        function showModal() {
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        }

        function hideModal() {
            confirmationModal.classList.remove('flex');
            confirmationModal.classList.add('hidden');
            loanToDeleteId = null;
            loanToDeleteNumber = null;
        }
        
        function showUnpaidConfirmationModal(unpaidCount) {
             unpaidCountSpan.textContent = unpaidCount;
             unpaidConfirmationModal.classList.remove('hidden');
             unpaidConfirmationModal.classList.add('flex');
        }
        
        function hideUnpaidConfirmationModal() {
             unpaidConfirmationModal.classList.remove('flex');
             unpaidConfirmationModal.classList.add('hidden');
        }


        function hideWhatsAppPrompt() {
            whatsappMessageBox.classList.remove('flex');
            whatsappMessageBox.classList.add('hidden');
            if (whatsappTimeout) {
                clearTimeout(whatsappTimeout);
                whatsappTimeout = null;
            }
        }

        function generateWhatsAppMessage(loan) {
            const paidValue = formatCurrency(loan.paidValue);
            const calculatedValue = formatCurrency(loan.calculatedValue);
            const method = loan.paymentMethod ? loan.paymentMethod.toUpperCase() : 'PENDING / UNKNOWN';
            const {
                date: dateString,
                time: timeString
            } = formatDateTime(loan.createdAt);
            // Receipt status is always FINAL PAID
            const paymentStatus = 'PAID (Final Status)'; 
            const addedBy = loan.addedByName ? loan.addedByName : 'N/A';
            const message = `*Siriwardana Mobile - LPR Official Receipt* ------------------------------ 
*TRANSACTION DETAILS* Loan Number: ${loan.loanNumber} 
Phone Number: ${loan.phoneNumber} 
Paid Value: ${paidValue} 
Net Calculated Value (-1.5% Transaction Fee): ${calculatedValue} 
Payment Method: ${method} 
Date/Time Recorded: ${dateString} ${timeString} 
Status: ${paymentStatus} 
Recorded By: ${addedBy} 
Thank you for your business! 
------------------------------ 
`;
            return encodeURIComponent(message);
        }

        function promptWhatsAppSend(loanId) {
            const loan = currentLoans.find(l => l.id === loanId);
            if (!loan) return;
            let phone = loan.phoneNumber.replace(/\D/g, '');
            if (phone.length === 10 && phone.startsWith('0')) {
                phone = '94' + phone.substring(1);
            } else if (phone.length === 9 && !phone.startsWith('0')) {
                phone = '94' + phone;
            }
            const message = generateWhatsAppMessage(loan);
            const whatsappUrl = `https://wa.me/${phone}?text=${message}`;
            whatsappMessageTitle.innerHTML = `Payment Confirmed! Send WhatsApp Receipt for Loan Number <span class="text-indigo-700">${loan.loanNumber}</span>`;
            whatsappSendButton.href = whatsappUrl;
            whatsappMessageBox.classList.remove('hidden');
            whatsappMessageBox.classList.add('flex');
            if (whatsappTimeout) clearTimeout(whatsappTimeout);
            whatsappTimeout = setTimeout(hideWhatsAppPrompt, 20000);
        }

        function showReceipt(id) {
            const loan = currentLoans.find(l => l.id === id);
            if (!loan) {
                showMessage("Record not found in the current list. Try refreshing.", true);
                return;
            }
            const {
                date,
                time
            } = formatDateTime(loan.createdAt); 
            
            // --- UPDATED LOGIC: Always show PAID (FINAL) on the Receipt ---
            const paymentStatusText = 'PAID (FINAL)';
            const statusColor = 'text-green-700'; // Always show green color
            // -----------------------------------------------------------
            
            const paymentMethod = loan.paymentMethod ? loan.paymentMethod.toUpperCase() : 'PENDING';
            const addedByName = loan.addedByName ? loan.addedByName : 'N/A'; 
            
            const receiptHtml = ` 
<div class="print-area w-full mx-auto font-mono text-sm leading-snug p-2"> 
    <div class="text-center mb-4"> 
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRn0Hz-y61XQ-3RgTeYFbMDN4ZaVuJozrSYJA&s" alt="App Logo" class="mx-auto h-16 w-16 object-cover rounded-xl mb-2" onerror="this.onerror=null; this.src='https://placehold.co/64x64/0000FF/FFFFFF?text=SM';"> 
        <h1 class="text-xl font-extrabold text-gray-900 uppercase">Siriwardana Mobile</h1> 
        <p class="text-sm font-medium pt-1 text-gray-800">0771248083</p> 
        <p class="text-xs text-gray-600">Kalugamuwa Road, Wariyapola</p> 
    </div> 
    <div class="border-b border-gray-900 border-dashed mb-4 pt-2"></div> 
    <div class="text-center mb-4 pb-2"> 
        <h2 class="text-lg font-bold text-gray-900">TRANSACTION RECEIPT</h2> 
        <p class="text-base font-bold text-gray-700">LPR</p> 
    </div> 
    <div class="space-y-1"> 
        <div class="flex justify-between"> 
            <span class="font-medium">Date/Time:</span> 
            <span class="font-semibold">${date} ${time}</span> 
        </div> 
        <div class="flex justify-between"> 
            <span class="font-medium">Loan Number:</span> 
            <span class="font-extrabold text-indigo-700">${loan.loanNumber}</span> 
        </div> 
        <div class="flex justify-between border-b pb-2"> 
            <span class="font-medium">Phone Number:</span> 
            <span class="font-semibold">${loan.phoneNumber}</span> 
        </div> 
        <h2 class="text-base font-bold pt-2 border-t border-dashed border-gray-400 text-center">PAYMENT SUMMARY</h2> 
        <div class="flex justify-between pt-2"> 
            <span class="font-medium">Payment Method:</span> 
            <span class="font-bold text-gray-800">${paymentMethod}</span> 
        </div> 
        <div class="flex justify-between text-lg pt-2"> 
            <span class="font-bold">Customer PAID Value:</span> 
            <span class="font-extrabold text-indigo-700">${formatCurrency(loan.paidValue)}</span> 
        </div> 
        <div class="flex justify-between pt-2 border-t border-dashed border-gray-400 mt-2"> 
            <span class="font-bold text-gray-800">Net Value (-1.5% Transaction Fee):</span> 
            <span class="font-extrabold text-green-700">${formatCurrency(loan.calculatedValue)}</span> 
        </div> 
        <p class="pt-4 text-xs text-center border-t mt-4 border-dashed border-gray-400 font-bold ${statusColor}"> Payment Status: ${paymentStatusText} </p> 
        <p class="text-xs text-center">Recorded By: ${addedByName}</p> 
        <p class="text-xs text-center pt-2">Thank you! Come again.</p> 
    </div> 
</div> 
`;
            receiptContent.innerHTML = receiptHtml;
            printContainer.innerHTML = receiptHtml;
            receiptModal.classList.remove('hidden');
            receiptModal.classList.add('flex');
        }

        function closeReceiptModal() {
            receiptModal.classList.remove('flex');
            receiptModal.classList.add('hidden');
        }

        function printReceipt() {
            window.print();
        }

        // ---------------------------------------------------------------------
        // Presence System Logic (NEW)
        // ---------------------------------------------------------------------

        async function updateUserPresence(status) {
            if (!db || !currentUserName || currentUserName === "N/A (Not Logged In)") return;
            
            const userRef = doc(db, USER_PRESENCE_PATH, currentUserName); 
            const presenceData = {
                name: currentUserName,
                status: status, // 'online' or 'offline'
                lastSeen: serverTimestamp(),
            };
            
            try {
                await setDoc(userRef, presenceData, { merge: true });
                console.log(`Presence updated for ${currentUserName}: ${status}`);
            } catch (error) {
                console.error("Error updating presence:", error);
            }
        }

        function listenForPresence() {
            if (!db) return;
            const presenceRef = collection(db, USER_PRESENCE_PATH);

            if (unsubscribePresence) {
                unsubscribePresence(); // Clear existing listener
            }

            unsubscribePresence = onSnapshot(presenceRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    onlineUsers[data.name] = data;
                });
                renderPresenceBadges();
                console.log("Real-time presence update received.");
            }, (error) => {
                console.error("Error listening to user presence:", error);
            });
        }

        function renderPresenceBadges() {
            if (cashierOnlineStatus.classList.contains('hidden')) {
                cashierOnlineStatus.classList.remove('hidden');
            }

            // Create a temporary object combining all known users with their current status
            const statusHtml = knownUsers.map(name => {
                const statusData = onlineUsers[name];
                let isOnline = false;
                let lastSeenTime = 'N/A';
                
                if (statusData && statusData.status === 'online') {
                    isOnline = true;
                } 
                
                if (statusData && statusData.lastSeen) {
                    const { time: timeString } = formatDateTime(statusData.lastSeen);
                    lastSeenTime = timeString;
                    
                    // Simple logic to detect if 'online' status is stale (e.g., older than 2 minutes)
                    if (isOnline) {
                        const lastSeenMs = statusData.lastSeen.toDate().getTime();
                        const nowMs = new Date().getTime();
                        if (nowMs - lastSeenMs > (2 * 60 * 1000)) { // 2 minutes stale
                            isOnline = false; // Treat as offline if stale
                        }
                    }
                }
                
                const statusClass = isOnline ? 'online-badge' : 'offline-badge';
                const dotClass = isOnline ? 'online-dot' : 'offline-dot';
                const statusText = isOnline ? 'ONLINE' : 'OFFLINE';
                const tooltipText = isOnline ? `Logged in now` : `Last seen: ${lastSeenTime}`;

                // Apply special styling to the logged-in user's badge
                const isCurrentUser = name === currentUserName && isOnline;
                const selfClass = isCurrentUser ? 'border-2 border-indigo-500 shadow-lg' : '';


                return `
                    <div class="${statusClass} ${selfClass}" title="${tooltipText}">
                        <div class="${dotClass}"></div>
                        ${name} (${statusText})
                    </div>
                `;
            }).join('');

            onlineStatusBadges.innerHTML = statusHtml;
        }

        // ---------------------------------------------------------------------
        // Settlement Logic 
        // ---------------------------------------------------------------------

        function listenForSettlementData() {
            if (!db) return;
            const settleRef = doc(db, 'settlement_status', 'user_settlements');
            
            onSnapshot(settleRef, (docSnap) => {
                if (docSnap.exists()) {
                    userSettlementDate = docSnap.data();
                    filterAndRenderLoans(); 
                    updateSettlementButtonVisibility(); 
                } else {
                    userSettlementDate = {};
                }
            }, (error) => {
                console.error("Error listening to settlement data:", error);
            });
        }
        
        function handleSettle(userName) {
            if(currentUserName !== userName || currentUserName === "N/A (Not Logged In)") {
                 showLoginMessage(`Error: You can only settle your own account (${userName}).`, true);
                return;
            }
            
            const todayDateString = getCurrentDateStringSLST();
            if (userSettlementDate[`${userName}_settledAtDate`] === todayDateString) {
                showLoginMessage(`Error: Your account has already been settled for today (${todayDateString}). You can only settle once per day.`, true);
                return;
            }

            userToSettle = userName;
            
            // Check for Unpaid Records before full settlement confirmation
            const unpaidPendingSettleRecords = currentLoans.filter(loan => {
                const name = loan.addedByName;
                const loanTimestamp = loan.createdAt?.toDate ? loan.createdAt.toDate().getTime() : (new Date(loan.createdAt)).getTime();
                const lastSettleDate = userSettlementDate[name];
                
                let isRecordPendingUnpaid = false;
                if (name === userName && !loan.isMarked) {
                     if (lastSettleDate) {
                        const lastSettleTimestamp = lastSettleDate.toDate().getTime();
                        // Check if the loan was created AFTER the last settlement
                        isRecordPendingUnpaid = loanTimestamp >= lastSettleTimestamp; 
                     } else {
                         isRecordPendingUnpaid = true;
                     }
                }
                
                return isRecordPendingUnpaid;
                
            });

            if (unpaidPendingSettleRecords.length > 0) {
                // If UNPAID records exist, show the UNPAID WARNING modal first
                showUnpaidConfirmationModal(unpaidPendingSettleRecords.length);
            } else {
                // If NO UNPAID records, proceed directly to the main SETTLEMENT confirmation modal
                settleModalUserNameSpan.textContent = userName;
                settleConfirmationModal.classList.remove('hidden');
                settleConfirmationModal.classList.add('flex');
            }
        }
        
        function proceedToMainSettleConfirmation() {
            hideUnpaidConfirmationModal();
            if (userToSettle) {
                 settleModalUserNameSpan.textContent = userToSettle;
                 settleConfirmationModal.classList.remove('hidden');
                 settleConfirmationModal.classList.add('flex');
            }
        }


        async function performSettlement() {
            if (!db || !userToSettle) return;
            confirmSettleButton.disabled = true;
            confirmSettleButton.textContent = 'Settling...';

            const todayDateString = getCurrentDateStringSLST();
            
            try {
                const settleRef = doc(db, 'settlement_status', 'user_settlements');
                
                // Final Check against race conditions
                if (userSettlementDate[`${userToSettle}_settledAtDate`] === todayDateString) {
                     showMessage(`Error: ${userToSettle}'s account has already been settled for today (${todayDateString}). You can only settle once per day.`, true);
                     return;
                }

                await setDoc(settleRef, {
                    // Store the current Server Timestamp (This is the cutoff point for the next summary calculation)
                    [userToSettle]: serverTimestamp(), 
                    // Store the date string to prevent settlement duplication today
                    [`${userToSettle}_settledAtDate`]: todayDateString 
                }, { merge: true });

                showMessage(`${userToSettle}'s account successfully settled. Summary has been reset.`, false);
                
                await new Promise(resolve => setTimeout(resolve, 500)); 

                settleConfirmationModal.classList.remove('flex');
                settleConfirmationModal.classList.add('hidden');
                
            } catch (error) {
                console.error("Error performing settlement:", error);
                showMessage(`Error performing settlement for ${userToSettle}: ${error.message}`, true);
            } finally {
                confirmSettleButton.disabled = false;
                confirmSettleButton.textContent = 'Confirm Settle';
                userToSettle = null;
            }
        }
        
        function updateSettlementButtonVisibility() {
            const todayDateString = getCurrentDateStringSLST();
            const settleButtons = document.querySelectorAll('.settle-button');
            settleButtons.forEach(button => {
                const buttonUser = button.dataset.user;
                const isSettledToday = userSettlementDate[`${buttonUser}_settledAtDate`] === todayDateString;

                if (buttonUser === currentUserName && currentUserName !== "N/A (Not Logged In)" && !isSettledToday) {
                    button.classList.remove('hidden-settle');
                    button.textContent = `${buttonUser}: Settle Now`; 
                } else if (buttonUser === currentUserName && isSettledToday) {
                    button.classList.add('hidden-settle'); // Hide if settled today
                    // Optionally show a message that they have settled for the day
                    // showMessage(`Note: Your account was settled today (${todayDateString}). Settlement button is hidden.`, false);
                } else {
                    button.classList.add('hidden-settle');
                }
            });
            if (currentUserName !== "N/A (Not Logged In)") {
                 settlementButtonsContainer.classList.remove('hidden');
            } else {
                 settlementButtonsContainer.classList.add('hidden');
            }
        }


        // ---------------------------------------------------------------------
        // END Settlement Logic
        // ---------------------------------------------------------------------


        // --- FIREBASE & AUTH LOGIC ---
        
        async function saveUserNameToProfile(name, userId) {
            if (!db || !userId) {
                console.error("Cannot save name: DB or User ID missing.");
                return;
            }
            try {
                const profileRef = doc(db, getUserProfilePath(userId)); 
                await setDoc(profileRef, {
                    name: name,
                    userId: userId,
                    lastUpdate: serverTimestamp()
                }, {
                    merge: true
                });
            } catch (error) {
                console.error("Error saving user profile:", error); 
            }
        }
        
        async function handleLogin() {
            const selectedName = loginUserNameSelect.value;
            const enteredPasscode = passcodeInput.value.trim();
            if (!selectedName || !enteredPasscode) {
                showLoginMessage("Please select a name and enter the passcode.", true);
                return;
            }
            loginButton.disabled = true;
            loginButton.textContent = 'Checking Passcode...'; 
            
            // --- PASSCODE CHECK (Using the newly added USER_PASSCODES object) ---
            const expectedPasscode = USER_PASSCODES[selectedName];
            if (enteredPasscode !== expectedPasscode) {
                showLoginMessage("Invalid Passcode. Please try again.", true);
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
                passcodeInput.value = '';
                passcodeInput.focus();
                return;
            } 
            
            // --- SUCCESSFUL LOGIN ---
            currentUserName = selectedName; 
            if (!auth || !currentUserId) {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    showLoginMessage(`Authentication Error: ${error.message}`, true);
                    console.error("Forced Anonymous Sign-In Failed:", error);
                    loginButton.disabled = false;
                    loginButton.textContent = 'Login';
                    return;
                }
            } 
            
            await saveUserNameToProfile(currentUserName, currentUserId); 
            
            userIdDisplay.textContent = `Logged in as: ${currentUserName} | User ID: ${currentUserId.substring(0, 8)}...`;
            loginSection.classList.add('hidden');
            mainAppContent.classList.remove('hidden');
            showLoginMessage(`Login Successful! Welcome, ${currentUserName}.`, false); 
            submitButton.textContent = 'Add Record and Print Receipt';
            submitButton.classList.remove('bg-gray-400');
            submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            submitButton.disabled = false; 
            
            // NEW: Set initial online status and start presence listener
            await updateUserPresence('online');
            listenForPresence(); 
            
            startRealTimeListener();
            listenForSettlementData(); 
            updateSettlementButtonVisibility(); 
            
            loginButton.disabled = false;
            loginButton.textContent = 'Login';
        }
        
        async function initializeAppAndAuth() {
            try {
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                userIdDisplay.textContent = 'Connecting to Cloud Database...'; 
                
                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid; 
                        userIdDisplay.textContent = `User ID: ${currentUserId.substring(0, 8)}... (Ready for Login)`;
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = 'Cloud Connection Failed!';
                        userIdDisplay.classList.remove('bg-indigo-100');
                        userIdDisplay.classList.add('bg-red-200', 'text-red-800');
                        showLoginMessage("Cloud Connection Failed. Please check console.", true);
                        loginButton.disabled = true;
                    }
                }, (error) => {
                    console.error("Auth Listener Setup Error:", error);
                    showLoginMessage(`Critical Auth Error: ${error.message}`, true);
                }); 

                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    } 
                } catch (error) {
                    console.error("Initial Sign-In Failed:", error);
                }
            } catch (error) {
                console.error("Firebase Initialization Fatal Error:", error);
                showLoginMessage(`Fatal Error: Could not initialize Firebase. Details: ${error.message}`, true);
            }
        }
        
        function startRealTimeListener() {
            if (!db || !isAuthReady) {
                console.warn("Firestore not ready or unauthorized.");
                return;
            }
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot(); // Clear existing listener
            }
            const loanRef = collection(db, LOAN_RECORDS_PATH);
            unsubscribeSnapshot = onSnapshot(loanRef, (snapshot) => {
                currentLoans = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })); 
                filterAndRenderLoans();
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showMessage(`Real-time data error: ${error.message}`, true);
            });
        }
        
        async function addLoan(loan, paymentMethod) {
            if (!isAuthReady || !currentUserId || currentUserName === "N/A (Not Logged In)") {
                showMessage("Cannot add record: Please log in first.", true);
                return;
            }
            submitButton.disabled = true;
            submitButton.textContent = 'Adding to Cloud...';
            try {
                const calculatedValue = loan.paidValue * 0.985;
                const newLoanData = {
                    loanNumber: loan.loanNumber,
                    phoneNumber: loan.phoneNumber,
                    amount: loan.amount,
                    paidValue: loan.paidValue,
                    calculatedValue: parseFloat(calculatedValue.toFixed(2)),
                    createdAt: serverTimestamp(),
                    isMarked: false,
                    paymentMethod: paymentMethod,
                    paidAt: null,
                    addedByUserId: currentUserId,
                    addedByName: currentUserName, 
                };
                const docRef = await addDoc(collection(db, LOAN_RECORDS_PATH), newLoanData);
                const newLoanId = docRef.id;
                const statusMessage = `Loan number ${loan.loanNumber} successfully added by ${currentUserName} (PENDING).`;
                showMessage(statusMessage, false);
                loanForm.reset();
                updateCalculatedPreview();
                updateAmountPreview();
                hideWhatsAppPrompt(); 
                
                const tempLoan = {
                    ...newLoanData,
                    id: newLoanId,
                    createdAt: new Date()
                }; 
                currentLoans.push(tempLoan);
                showReceipt(newLoanId); 
                setTimeout(printReceipt, 500);
            } catch (error) {
                console.error("Error adding record to Firestore:", error);
                showMessage(`Error adding record: ${error.message}`, true);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Add Record and Print Receipt';
                submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                submitButton.classList.remove('bg-gray-400');
            }
        }
        
        async function markAsPaid(id) {
            if (!isAuthReady || !currentUserId || currentUserName === "N/A (Not Logged In)") {
                showMessage("Cannot mark as paid: Please log in first.", true);
                return;
            }
            const loan = currentLoans.find(l => l.id === id);
            if (!loan) {
                showMessage("Error: Loan record not found in cache.", true);
                return;
            }
            if (loan.isMarked) {
                showMessage(`Loan number ${loan.loanNumber} is already marked as PAID.`, true);
                return;
            }
            let method = loan.paymentMethod;
            if (!method || method === '') {
                // If payment method is not set, default to Cash, as payment is being confirmed now
                method = 'Cash'; 
                // Note: The previous logic relied on the radio buttons *before* submission. Now, we force a method if missing during marking.
            }
            try {
                const loanDocRef = doc(db, LOAN_RECORDS_PATH, id);
                await updateDoc(loanDocRef, {
                    isMarked: true,
                    paymentMethod: method,
                    paidAt: serverTimestamp(),
                    markedByUserId: currentUserId,
                    markedByName: currentUserName 
                });
                showMessage(`Loan number ${loan.loanNumber}: Payment confirmed as FINAL by ${currentUserName}. Method: ${method.toUpperCase()}.`, false);
                promptWhatsAppSend(id);
            } catch (error) {
                console.error("Error marking record as paid:", error);
                showMessage(`Error marking record as paid: ${error.message}`, true);
            }
        }
        
        async function performActualDelete(id, loanNumber) {
            if (!isAuthReady || !currentUserId || currentUserName === "N/A (Not Logged In)") {
                showMessage("Cannot delete record: Please log in first.", true);
                return;
            }
            try {
                const loanDocRef = doc(db, LOAN_RECORDS_PATH, id);
                await deleteDoc(loanDocRef);
                showMessage(`Loan number ${loanNumber} successfully deleted from Cloud by ${currentUserName}.`, false);
                hideWhatsAppPrompt();
            } catch (error) {
                console.error("Error deleting record from Firestore:", error);
                showMessage(`Error deleting record: ${error.message}`, true);
            }
        }

        function deleteLoan(id, loanNumber) {
            loanToDeleteId = id;
            loanToDeleteNumber = loanNumber;
            modalLoanNumberSpan.textContent = loanNumber;
            hideWhatsAppPrompt();
            showModal();
        } 
        
        function filterAndRenderLoans() {
            const sortedLoans = [...currentLoans].sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (new Date(a.createdAt)).getTime();
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (new Date(b.createdAt)).getTime();
                return dateB - dateA; 
            });
            
            // --- Summary Calculation Logic (Reset after Settlement) ---
            let userTotals = {
                Ashan: {
                    count: 0,
                    netValue: 0
                },
                Dilshan: {
                    count: 0,
                    netValue: 0
                },
                Gihan: {
                    count: 0,
                    netValue: 0
                },
                Menushi: {
                    count: 0,
                    netValue: 0
                }
            };
            
            const allRecords = sortedLoans;
            
            allRecords.forEach(loan => { 
                const name = loan.addedByName;
                const netValue = loan.calculatedValue || 0;
                
                // 1. Paid ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∂ª ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂ú‡∂´‡∂±‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
                if (!loan.isMarked) { 
                    return; 
                }

                // 2. Settlement ‡∂≠‡∂ª‡∑ä‡∂ö‡∂∫ ‡∂∫‡∑ú‡∂Ø‡∂±‡∑ä‡∂±: lastSettleDate ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂¥‡∑É‡∑î ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑Ö ‡∂ª‡∑ô‡∂ö‡∑ù‡∂© ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
                const lastSettleDate = userSettlementDate[name];
                let isSettled = false;
                
                if (lastSettleDate && lastSettleDate.toDate) { // Check if it's a Firestore Timestamp object
                    // Use the timestamp of when the record was *created* for comparison
                    const loanTimestamp = loan.createdAt?.toDate ? loan.createdAt.toDate().getTime() : (new Date(loan.createdAt)).getTime();
                    const lastSettleTimestamp = lastSettleDate.toDate().getTime(); 

                    // Logic: If loan timestamp is strictly BEFORE the settlement timestamp, it's settled.
                    if (loanTimestamp < lastSettleTimestamp) { 
                        isSettled = true; 
                    } else {
                        isSettled = false; // Summary includes records created exactly at or after the settlement moment.
                    }
                }

                if (!isSettled) { 
                    if (userTotals.hasOwnProperty(name)) {
                        userTotals[name].count++;
                        userTotals[name].netValue += netValue;
                    }
                }
            }); 
            
            if (ashanCountSpan) {
                ashanCountSpan.textContent = userTotals.Ashan.count;
                ashanNetTotalSpan.textContent = formatCurrency(userTotals.Ashan.netValue);
            }
            if (dilshanCountSpan) {
                dilshanCountSpan.textContent = userTotals.Dilshan.count;
                dilshanNetTotalSpan.textContent = formatCurrency(userTotals.Dilshan.netValue);
            }
            if (gihanCountSpan) {
                gihanCountSpan.textContent = userTotals.Gihan.count;
                gihanNetTotalSpan.textContent = formatCurrency(userTotals.Gihan.netValue);
            }
            if (menushiCountSpan) {
                menushiCountSpan.textContent = userTotals.Menushi.count;
                menushiNetTotalSpan.textContent = formatCurrency(userTotals.Menushi.netValue);
            } 
            
            
            // --- Table Rendering Logic (Show records added after last settlement / or specific filtered date) ---
            let selectedDate = filterDateInput.value; 
            const searchInput = searchLoanNumberInput.value.toLowerCase().trim();
            let loansToRender = sortedLoans; 
            
            // üõë CRITICAL CHANGE: If NO filter date AND NO search input, apply the Settlement Filter
            if (!selectedDate && !searchInput) { 
                loansToRender = loansToRender.filter(loan => {
                    const name = loan.addedByName;
                    const lastSettleDate = userSettlementDate[name];
                    
                    // If no settlement has been done for this user, show today's records only (to manage initial list size)
                    if (!lastSettleDate || !lastSettleDate.toDate) {
                         return getDateStringFromISO(loan.createdAt) === getCurrentDateStringSLST(); 
                    }
                    
                    const loanTimestamp = loan.createdAt?.toDate ? loan.createdAt.toDate().getTime() : (new Date(loan.createdAt)).getTime();
                    const lastSettleTimestamp = lastSettleDate.toDate().getTime(); 

                    // Show all records added AT or AFTER the last settlement timestamp
                    return loanTimestamp >= lastSettleTimestamp; 
                });
            } else {
                 // If filter date OR search input is selected, apply the relevant filter only (SKIPPING Settlement Filter)
                 if (selectedDate) {
                    loansToRender = loansToRender.filter(loan => { 
                        return getDateStringFromISO(loan.createdAt) === selectedDate;
                    });
                 }
                 if (searchInput) { 
                    // Search is done on the full list if no date filter is applied, or on the date-filtered list if a date is present.
                    loansToRender = loansToRender.filter(loan => {
                        return loan.loanNumber.toLowerCase().includes(searchInput);
                    });
                 }
                 // The Settlement Filter is SKIPPED here, allowing search/date filter to override it.
            } 
            
            // Calculate totals for the header based on loansToRender (filtered list)
            const paidLoansToRender = loansToRender.filter(loan => loan.isMarked); 
            let totalNetValue = paidLoansToRender.reduce((sum, loan) => sum + loan.calculatedValue, 0);
            if (totalNetValueSpan) {
                totalNetValueSpan.textContent = formatCurrency(totalNetValue);
            } 
            let markedCount = paidLoansToRender.length;
            if (totalMarkedCountSpan) {
                totalMarkedCountSpan.textContent = markedCount.toString();
            } 
            
            // --- UPDATED PAYMENT METHOD CALCULATION ---
            let cashCount = 0;
            let cardCount = 0;
            let onlineCount = 0;
            
            let cashValue = 0; // NEW VALUE
            let cardValue = 0; // NEW VALUE
            let onlineValue = 0; // NEW VALUE

            paidLoansToRender.forEach(loan => {
                const method = (loan.paymentMethod || '').toLowerCase();
                const netValue = loan.calculatedValue || 0;
                
                if (method === 'cash') {
                    cashCount++;
                    cashValue += netValue; // Accumulate value
                } else if (method === 'card') {
                    cardCount++;
                    cardValue += netValue; // Accumulate value
                } else if (method === 'online') {
                    onlineCount++;
                    onlineValue += netValue; // Accumulate value
                }
            }); 

            // Update Counts (Existing)
            cashCountSpan.textContent = cashCount.toString();
            cardCountSpan.textContent = cardCount.toString();
            onlineCountSpan.textContent = onlineCount.toString(); 
            
            // Update Values (NEW)
            cashValueSpan.textContent = formatCurrency(cashValue); 
            cardValueSpan.textContent = formatCurrency(cardValue);
            onlineValueSpan.textContent = formatCurrency(onlineValue);
            
            
            renderLoansTable(loansToRender);
        }

        function renderLoansTable(loans) {
            if (!isAuthReady) {
                loanTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">Connecting to Cloud Database...</td></tr>`;
                return;
            }
            if (currentUserName === "N/A (Not Logged In)") {
                loanTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-yellow-700 font-bold">Please log in using your name and passcode to view records.</td></tr>`;
                return;
            }
            
            if (loans.length === 0) {
                const filterActive = filterDateInput.value || searchLoanNumberInput.value;
                let message = filterActive ? 'No records match the current filters.' : 'No new records added since last settlement / No records today.'; 
                loanTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500">${message}</td></tr>`;
                return;
            }
            loanTableBody.innerHTML = loans.map((loan, index) => {
                const {
                    date,
                    time
                } = formatDateTime(loan.createdAt);
                const isEven = index % 2 === 0;
                const isPaid = loan.isMarked;
                let rowClass = (isPaid ? 'paid-row' : (isEven ? 'bg-gray-50' : 'bg-white')); 
                const paidValueFormatted = formatCurrency(loan.paidValue);
                const calculatedValueFormatted = formatCurrency(loan.calculatedValue);
                let paymentMethodContent = '';
                let finalStatusContent = '';
                let method = loan.paymentMethod ? loan.paymentMethod.toUpperCase() : 'PENDING'; 
                
                let badgeColor = 'bg-yellow-500';
                let methodText = method;
                if (isPaid) {
                    if (method === 'CASH') {
                        badgeColor = 'bg-green-600';
                    } else if (method === 'CARD') {
                        badgeColor = 'bg-blue-600';
                    } else if (method === 'ONLINE') {
                        badgeColor = 'bg-purple-600';
                    }
                } else if (method === 'PENDING' || method === '') {
                    methodText = 'PENDING (None)';
                }
                paymentMethodContent = ` 
<span class="px-3 py-1 text-xs font-bold text-white uppercase rounded-full ${badgeColor} shadow-md"> 
    ${methodText} 
</span> 
`; 
                const checkboxStatusText = isPaid ? 'PAID (Final)' : 'Mark as Paid';
                finalStatusContent = ` 
<div class="flex flex-col items-center justify-center p-2"> 
    <input type="checkbox" id="cb-${loan.id}" class="form-checkbox text-red-600 rounded large-checkbox" ${isPaid ? 'checked disabled' : ''} ${!isPaid ? `onclick="window.markAsPaid('${loan.id}')"` : ''} title="${checkboxStatusText}"> 
    <label for="cb-${loan.id}" class="text-xs font-semibold mt-2 ${isPaid ? 'text-green-700' : 'text-red-600'}"> 
        ${checkboxStatusText} 
    </label> 
</div> 
`; 
                const addedByName = loan.addedByName || 'N/A (No Name)';
                return ` 
<tr class="${rowClass} hover:bg-gray-100 transition duration-100"> 
    <td class="px-4 py-3 whitespace-nowrap text-xs text-center font-medium text-gray-500">${date}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-xs text-center font-mono text-indigo-500">${time}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${loan.loanNumber}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${loan.phoneNumber}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-center text-indigo-700">${paidValueFormatted}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-center text-green-700">${calculatedValueFormatted}</td> 
    <td class="px-4 py-3 whitespace-nowrap text-center text-sm flex flex-col space-y-1 sm:block sm:space-y-0"> 
        <button onclick="window.deleteLoan('${loan.id}', '${loan.loanNumber}')" class="text-red-600 hover:text-red-800 font-semibold transition duration-150 p-2 rounded-lg hover:bg-red-100 w-full sm:w-auto"> Delete </button> 
        <button onclick="window.showReceipt('${loan.id}')" title="View Receipt" class="font-semibold transition duration-150 p-2 rounded-lg mt-1 sm:mt-0 ml-0 sm:ml-2 w-full sm:w-auto text-blue-600 hover:text-blue-800 hover:bg-blue-100"> Reprint </button> 
    </td> 
    <td class="px-4 py-3 whitespace-nowrap text-center text-sm border-l border-gray-200"> 
        ${paymentMethodContent} 
    </td> 
    <td class="px-4 py-3 text-center text-sm"> 
        ${finalStatusContent} 
    </td> 
    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-indigo-600"> 
        ${addedByName} 
    </td> 
</tr> 
`;
            }).join('');
        }

        function downloadLoansAsCSV() {
            if (currentLoans.length === 0) {
                showMessage("No data to download.", true);
                return;
            } 
            const loansToCopy = [...currentLoans].sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (new Date(a.createdAt)).getTime();
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (new Date(b.createdAt)).getTime();
                return dateB - dateA;
            });
            if (loansToCopy.length === 0) {
                showMessage("No records found for download.", true);
                return;
            }
            const SEPARATOR = ',';
            const BOM = "\ufeff";
            
            // --- UPDATED HEADERS ---
            const headers = [
                "Reported Date",
                "Reported Time",
                "Loan Number",
                "Phone Number",
                "Principal Loan Amount (Rs.)",
                "Customer Paid Value (Rs.)",
                "Calculated Net Value (-1.5%) (Rs.)",
                "Paid Status (Is Checked)",
                "Payment Method - CASH (Rs.)",   // NEW COLUMN 1
                "Payment Method - CARD (Rs.)",   // NEW COLUMN 2
                "Payment Method - ONLINE (Rs.)", // NEW COLUMN 3
                "Added By User Name",
                "Added By User ID"
            ];
            
            const csvRows = loansToCopy.map(loan => {
                const {
                    date,
                    time
                } = formatDateTime(loan.createdAt);
                const paidStatus = loan.isMarked ? 'FINAL_PAID' : 'PENDING';
                const paymentMethod = loan.paymentMethod || 'NONE';
                const addedByName = loan.addedByName || 'N/A';
                const addedByUserId = loan.addedByUserId || 'N/A';
                
                const paidValue = loan.paidValue || 0;
                
                // --- NEW: Distribute Paid Value to correct Payment Method column ---
                let cashValue = 0;
                let cardValue = 0;
                let onlineValue = 0;

                // We only apply the value to the method if the record is PAID/MARKED
                if (loan.isMarked) { 
                    const method = paymentMethod.toUpperCase();
                    if (method === 'CASH') {
                        cashValue = paidValue;
                    } else if (method === 'CARD') {
                        cardValue = paidValue;
                    } else if (method === 'ONLINE') {
                        onlineValue = paidValue;
                    }
                    // If method is 'NONE' or empty for a PAID record, it defaults to 0 in all columns. 
                    // This should not happen if the user followed the input form correctly.
                }

                return [
                    `"${date}"`,
                    `"${time}"`,
                    `"${loan.loanNumber}"`,
                    `"${loan.phoneNumber}"`,
                    loan.amount,
                    paidValue,
                    loan.calculatedValue,
                    `"${paidStatus}"`,
                    cashValue,   // Cash Column Value
                    cardValue,   // Card Column Value
                    onlineValue, // Online Column Value
                    `"${addedByName}"`,
                    `"${addedByUserId}"`
                ].join(SEPARATOR);
            });
            const csvContent = BOM + [
                headers.join(SEPARATOR),
                ...csvRows
            ].join('\n');
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Siriwardana_Mobile_LPR_Records_Cloud_${getDateStringFromISO(new Date().toISOString())}_ALL.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("‚úÖ All records successfully downloaded as Excel (CSV) file.", false);
        } 

        // --- DARK MODE LOGIC ---

        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
            modeLabel.textContent = 'Dark Mode';
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
            modeLabel.textContent = 'Light Mode';
        }

        // --- Event Listeners ---
        
        // NEW: Handle user going offline when closing/leaving the page
        window.addEventListener('beforeunload', () => {
            if (currentUserName && currentUserName !== "N/A (Not Logged In)") {
                updateUserPresence('offline');
            }
        });

        loginButton.addEventListener('click', handleLogin);
        passcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleLogin();
            }
        }); 
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        }); 
        paidValueInput.addEventListener('input', updateCalculatedPreview);
        amountInput.addEventListener('input', updateAmountPreview);
        filterDateInput.addEventListener('change', filterAndRenderLoans);
        searchLoanNumberInput.addEventListener('input', filterAndRenderLoans);
        downloadExcelButton.addEventListener('click', downloadLoansAsCSV); 
        confirmDeleteButton.addEventListener('click', () => {
            if (loanToDeleteId && loanToDeleteNumber) {
                performActualDelete(loanToDeleteId, loanToDeleteNumber);
                hideModal();
            } else {
                hideModal();
            }
        });
        cancelButton.addEventListener('click', hideModal);
        closeReceiptButton.addEventListener('click', closeReceiptModal);
        printButton.addEventListener('click', printReceipt); 
        clearFilterButton.addEventListener('click', function() {
            filterDateInput.value = ''; 
            searchLoanNumberInput.value = '';
            filterAndRenderLoans(); 
            showMessage('Date filter cleared. Showing records since last settlement.', false);
        });

        // --- Settlement Event Listeners ---
        document.querySelectorAll('.settle-button').forEach(button => {
            // UPDATED: Call handleSettle when button is clicked (This is the confirmation trigger)
            button.addEventListener('click', () => {
                handleSettle(button.dataset.user);
            });
        });

        confirmSettleButton.addEventListener('click', performSettlement);
        cancelSettleButton.addEventListener('click', () => {
            settleConfirmationModal.classList.remove('flex');
            settleConfirmationModal.classList.add('hidden');
            userToSettle = null;
        });
        
        // Unpaid Confirmation Modal Listeners
        okUnpaidSettleButton.addEventListener('click', proceedToMainSettleConfirmation);
        cancelUnpaidSettleButton.addEventListener('click', hideUnpaidConfirmationModal);


        // Initial call to set up Firebase and Authentication
        initializeAppAndAuth(); 
        
        // Initial Dark Mode Check
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        } 
        
        // Attach global functions for HTML (onclick) access
        window.markAsPaid = markAsPaid;
        window.deleteLoan = deleteLoan;
        window.showReceipt = showReceipt; 
        
        // Form submission listener
        loanForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const loanNumber = document.getElementById('loanNumber').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const paidValue = parseFloat(paidValueInput.value);
            const paymentMethod = document.querySelector('input[name="paymentMethodRadio"]:checked').value;
            if (loanNumber.length !== 13) {
                showMessage("Error: Loan Number must be exactly 13 digits.", true);
                return;
            }
            const loanData = {
                loanNumber,
                phoneNumber,
                amount,
                paidValue
            };
            addLoan(loanData, paymentMethod);
        });
        
        // Initial call to hide all buttons until login
        updateSettlementButtonVisibility();

    </script>
</body>
</html>